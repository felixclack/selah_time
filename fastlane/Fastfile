default_platform(:ios)

platform :ios do
  before_all do
    if ENV["CI"]
      setup_ci
    end
  end

  private_lane :require_env do |options|
    keys = Array(options[:keys])
    keys.each do |key|
      UI.user_error!("Missing required env var: #{key}") if ENV[key].to_s.empty?
    end
  end

  private_lane :app_identifier do
    ENV["APP_IDENTIFIER"] || "com.goodstack.Selah"
  end

  private_lane :app_identifiers do
    if ENV["APP_IDENTIFIERS"] && !ENV["APP_IDENTIFIERS"].strip.empty?
      ENV["APP_IDENTIFIERS"].split(",").map(&:strip)
    else
      [
        app_identifier,
        "com.goodstack.Selah.ShieldExtension",
        "com.goodstack.Selah.DeviceActivityExtension"
      ]
    end
  end

  private_lane :asc_api_key do
    require_env(keys: ["ASC_KEY_ID", "ASC_ISSUER_ID", "ASC_KEY_PATH"])
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_KEY_PATH"],
      in_house: false,
      duration: 1200
    )
  end

  private_lane :setup_signing do |type:|
    require_env(keys: ["MATCH_GIT_URL"])
    match(
      type: type,
      app_identifier: app_identifiers,
      git_url: ENV["MATCH_GIT_URL"],
      readonly: ENV["MATCH_READONLY"] == "1",
      keychain_name: ENV["MATCH_KEYCHAIN_NAME"],
      keychain_password: ENV["MATCH_KEYCHAIN_PASSWORD"]
    )
  end

  private_lane :set_version_and_build do |use_testflight:, api_key:|
    if ENV["VERSION_NUMBER"] && !ENV["VERSION_NUMBER"].strip.empty?
      increment_version_number(version_number: ENV["VERSION_NUMBER"].strip)
    end

    if ENV["BUILD_NUMBER"] && !ENV["BUILD_NUMBER"].strip.empty?
      increment_build_number(build_number: ENV["BUILD_NUMBER"].strip)
    else
      current = if use_testflight
        latest_testflight_build_number(api_key: api_key, app_identifier: app_identifier) rescue nil
      else
        latest_app_store_build_number(api_key: api_key, app_identifier: app_identifier) rescue nil
      end
      next_build = (current || 0) + 1
      increment_build_number(build_number: next_build)
    end
  end

  private_lane :build_release do
    build_app(
      scheme: "Selah",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      output_directory: "fastlane/build",
      output_name: "Selah.ipa"
    )
  end

  desc "Create the App Store Connect app record"
  lane :create_app do
    asc_api_key
    produce(
      username: ENV["FASTLANE_USER"] || ENV["PRODUCE_USERNAME"],
      app_identifier: app_identifier,
      app_name: ENV["APP_NAME"] || "Selah",
      sku: ENV["APP_SKU"] || "selah-ios",
      language: ENV["APP_PRIMARY_LANGUAGE"] || "en-US",
      team_id: ENV["APPLE_TEAM_ID"],
      skip_devcenter: ENV["SKIP_DEVCENTER"] == "1"
    )
  end

  desc "Enable Screen Time (Family Controls) entitlement on app and extensions"
  lane :register_screentime do
    require_env(keys: ["FASTLANE_USER", "APPLE_TEAM_ID"])
    username = ENV["FASTLANE_USER"] || ENV["PRODUCE_USERNAME"]
    team_id = ENV["APPLE_TEAM_ID"] || ENV["FASTLANE_TEAM_ID"]

    app_identifiers.each do |identifier|
      modify_services(
        username: username,
        app_identifier: identifier,
        team_id: team_id,
        services: {
          family_controls: "on"
        }
      )
    end
  end

  desc "Run unit tests in the simulator (SelahSim target)"
  lane :tests do
    scan(
      scheme: "SelahSim",
      clean: true,
      device: "iPhone 15",
      derived_data_path: "DerivedData",
      result_bundle: true
    )
  end

  desc "Build and upload to TestFlight"
  lane :testflight do
    api_key = asc_api_key
    setup_signing(type: "appstore")
    set_version_and_build(use_testflight: true, api_key: api_key)
    build_release

    upload_to_testflight(
      api_key: api_key,
      changelog: ENV["CHANGELOG"],
      groups: ENV["TESTFLIGHT_GROUPS"]&.split(",")&.map(&:strip),
      notify_external_testers: ENV["TESTFLIGHT_NOTIFY_EXTERNAL"] == "1",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Upload metadata/screenshots without uploading a new build"
  lane :metadata do
    api_key = asc_api_key
    deliver(
      api_key: api_key,
      force: true,
      skip_binary_upload: true,
      skip_screenshots: !File.directory?("fastlane/screenshots"),
      skip_metadata: !File.directory?("fastlane/metadata"),
      app_identifier: app_identifier
    )
  end

  desc "Build and upload to App Store (optionally submit for review)"
  lane :appstore do
    api_key = asc_api_key
    setup_signing(type: "appstore")
    set_version_and_build(use_testflight: false, api_key: api_key)
    build_release

    deliver(
      api_key: api_key,
      force: true,
      skip_screenshots: !File.directory?("fastlane/screenshots"),
      skip_metadata: !File.directory?("fastlane/metadata"),
      submit_for_review: ENV["SUBMIT_FOR_REVIEW"] == "1",
      automatic_release: ENV["AUTOMATIC_RELEASE"] == "1",
      phased_release: ENV["PHASED_RELEASE"] == "1",
      app_identifier: app_identifier
    )
  end
end
